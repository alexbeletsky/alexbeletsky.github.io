
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Alexander Beletsky's development blog</title>
  <meta name="author" content="Alexander Beletsky">

  
  <meta name="description" content="Why New Technologies Move Your Product Faster? Dec 13th, 2011 MVC, Mind, asp.net This summer my company e-conomic started new project with a working &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://beletsky.net/blog/page/10/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/fontello.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/pure-min.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/style.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Alexander Beletsky's development blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:800' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16388698-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
	<header class="pure-g-r"><div class="pure-g-r">
	<div class="inner pure-u-1">
		<h4 class="light">Alexander Beletsky's development blog</h4>
		<h1><a href="/">My profession is engineering</a></h1>
		<nav role="navigation" class="pure-menu pure-menu-open pure-menu-horizontal light"><ul>
	<li><a href="/projects">Projects</a></li>
	<li><a href="/talks">Talks</a></li>
	<li><a href="/blog/archives">Archive</a></li>
	<li><a href="/about">About me</a></li>
</ul>

</nav>
	</div>
</div>

</header>
	<div class="social inner pure-menu-horizontal"><ul>
	<li><a class="twitter icon-twitter" href="http://twitter.com/alexbeletsky"></a></li>
	<li><a class="github icon-github-circled" href="https://github.com/alexanderbeletsky"></a></li>
	<li><a class="stackoverflow icon-stackoverflow" href="http://stackoverflow.com/users/386751/alexanderb"></a></li>
	<li><a class="rss icon-rss" href="http://feeds.feedburner.com/abeletskyblog"></a></li>
</ul>
</div>
	<div id="content" class="inner pure-g-r"><div class="blog-index">
  
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/12/why-new-technologies-move-your-product.html">
    
      Why New Technologies Move Your Product Faster?</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-12-13T10:15:00+02:00" pubdate data-updated="true">Dec 13<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/mvc/'>MVC</a>, <a class='category' href='/blog/categories/mind/'>Mind</a>, <a class='category' href='/blog/categories/asp-dot-net/'>asp.net</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>This summer my company <a href="http://www.e-conomic.co.uk/">e-conomic</a> started new project with a working title SBA (Small Business Accounting). The project is about the creation of the product for small business owner, like consultants,  web shops, freelancers etc. Since my company already had great expertise in that area the product vision and initial backlog of stories was already in place. Even more, we already had a product that does nearly the same but for a different target user - so, it was kind of natural to try to build SBA based on existing one. We started our journey having very ambitious plan in our mind meaning release in less than 6 month.<br />
</p><p>But to our great disappointment the progress for next 2 month appeared very low. We underestimated one thing - the existing product is a great  but some of the underlying technologies were ill-suited for the new projects. Very simple things, like adding new custom form, UI changes, data access etc. were hard and unpleasant.<br />
</p><p>The legacy code, de-motivation and low progress.. were about to bury the project. Fortunately, the company were brave enough to change something on a fly. We went a very risky way, to build new product not based on old technologies, but almost from scratch. And as for me, that was great decision! So, somewhere in October we re-started the project.<br />
</p><p>What have we changed and how it went?<br />
</p><h2>SVN => Git</h2><p>I have <a href="http://www.beletsky.net/2011/06/how-to-start-using-git-in-svn-based.html">posted earlier</a> some my experience of starting to use Git in SVN-based organization. That time it was 2-3 people that tried to adopt that process, now it is only 2-3 who are not using it. We are thinking about moving to pure Git environment, but our deployment procedure slightly depends on SVN. As soon as we fix it, we can get rid of SVN completely.<br />
</p><p>You might argue, that changing source management tool is not exactly technological change and not affecting development velocity! But wait a minute.. How much time did you waste to resolve stupid tree conflicts? How much time you waste waiting for new branch, at the code freeze period? How many times your thrown away yours refactoring results, simply because you are not able to commit that now? <br />
</p><p>All of that factors are contra-productive. It could be not even seen from first sight, but Git improves the velocity simply by getting rid of annoying things that are natural to centralized source control management systems.<br />
</p><a href="https://lh5.googleusercontent.com/-XG2gEof9UpY/TucIbWZAFWI/AAAAAAAAH1A/1CWmMN_-chQ/s620/git.jpg"><br />
<img src="https://lh5.googleusercontent.com/-XG2gEof9UpY/TucIbWZAFWI/AAAAAAAAH1A/1CWmMN_-chQ/s620/git.jpg" alt="git" /><br />
</a><br />
<h2>ASP.NET WebForms => ASP.NET MVC</h2><p>Supporting WebForm&#8217;s code is a big mess. It&#8217;s is difficult to test, difficult to understand and to change. We had a bunch of custom controls that worked fine, but adopting them to something different is hard.<br />
</p><p>For the year I&#8217;m <a href="http://www.beletsky.net/search/label/MVC">studding</a> ASP.NET MVC and much inspired by it&#8217;s clear and powerful design. So, I was really happy we finally <a href="http://www.beletsky.net/2011/10/integrating-aspnet-mvc-into-legacy-web.html">moved</a> that direction. <br />
</p><p>We are using MVC in both modes: as for our web UI pages and for REST services. The same URL could produce both HTML or JSON response, depending on context. Having that, we are much flexible and not duplicate the code on pages and web services. MVC controllers are easy testable, Views are clean having only HTML with only few server side code snippets. Switch to ASP.NET MVC boosts us pretty much.<br />
</p><p>I think the adaption of new technology was really fast, even if we had some issues at the beginning they have been solved. I have to say that to use ASP.NET MVC we have to update production environment, namely upgrade in Windows 2008 with II7 which requires additional investment. But I think it&#8217;s only for good, cause having environment debt is the same as having technical debt in code.<br />
</p><a href="https://lh6.googleusercontent.com/-3FyOP31U69I/TucImLlSZvI/AAAAAAAAH1I/lWulB9EVFeo/s620/mvc.jpg"><br />
<img src="https://lh6.googleusercontent.com/-3FyOP31U69I/TucImLlSZvI/AAAAAAAAH1I/lWulB9EVFeo/s620/mvc.jpg" alt="asp.net mvc" /><br />
</a><br />
<h2>Pure jQuery => Backbone.js</h2><p>jQuery is the best javascript framework ever. It suites so nicely till the application is not getting to much big. As you getting out some imaginary &#8220;bounds&#8221; jQuery code get out of the control. Till that time we already had huge amount of .js files mixing out logic and UI stuff. <br />
</p><p>We were choosing between Knockout.js and Backbone.js and finally stopped at Backbone. Backbone.js introduce order in client-side code. It has clear separation of concerns for Models, Views, Controllers.. so we can say Backbone.js is MVC framework on client.<br />
</p><p>Having order is first step for productivity. The things are more predicable, read more fast to getting things done. Of cause, it takes a lot of effort to learn it. And no surprise some we still having some challenges caused by lack of expertise. But having <a href="http://lostechies.com/derickbailey/">Derick Bailey</a> as our consultant making it better. <br />
</p><p>I would add that ASP.NET MVC and Backbone.js suits each other very nicely, since Backbone.js is REST oriented and ASP.NET MVC exposing REST in a right way.<br />
</p><a href="https://lh6.googleusercontent.com/-Ww_ElYoIAVo/TucIx1wP6tI/AAAAAAAAH1Q/jmKpUE2jjQY/s620/backbone.jpg"><br />
<img src="https://lh6.googleusercontent.com/-Ww_ElYoIAVo/TucIx1wP6tI/AAAAAAAAH1Q/jmKpUE2jjQY/s620/backbone.jpg" alt="backbone.js" /><br />
</a><br />
<h2>Super.Tricky.NHibernate.Wrapper => ADO.NET</h2><p>One of the pain-in-neck points of our application is data access. We have huge wrapper around the NHibernate framework. Words &#8220;Wrapper on NHibernate&#8221; could make someone sick, what if I say, &#8220;Wrapper on HHibernate, which is code generated&#8221;? <br />
</p><p>So, someone might treat that are making step back. But I don&#8217;t agree. Whatever things you can do in C# code, it is SQL only the language your Database can speak. Having a ORM&#8217;s are kind of having translator during the conversation with foreign guy. It works great as soon you speak simply, it&#8217;s getting worse than conversation going complicated, so translator hardly could translate everything you want to say. And of cause, it almost has no sense to have a translator, as soon if you can speak that language.<br />
</p><p>We are not using pure ADO.NET, it would be complicated. We have a tiny wrapper on that that basically run queries and returns result sets. It might seem harder, but I would say it&#8217;s very flexible. You can create what ever queries you need and map them what ever models you have. It works fine, it works fast. It is easy to test, since you no longer need NHibernate profiler to understand what&#8217;s wrong in you application, code just close to you.<br />
</p><p>After last <a href="http://kievalt.net/">Kiev ALT.NET</a> meeting I understood we are not alone here. A lot of people start to understand that NHibernate becoming to heavyweight. New movement of MicroORM&#8217;s appeared, that combines power of SQL and functionality of mapping tables to objects. I want to believe that some MicroORM framework could be our next thing to adopt. <br />
</p><a href="https://lh5.googleusercontent.com/-8g_ydfqm6NU/TucI50rybVI/AAAAAAAAH1Y/PzhnR_Eudzo/s623/sql.jpg"><br />
<img src="https://lh5.googleusercontent.com/-8g_ydfqm6NU/TucI50rybVI/AAAAAAAAH1Y/PzhnR_Eudzo/s623/sql.jpg" alt="sql" /><br />
</a><br />
<h2>De-motivation => Obsession</h2><p>It is not technological factor.. it is not even something I easy describe. Developers are taking responsibility by changing the things or advocating for some particular technology. You are no longer have excuse of bad quality because of legacy reasons. Sure, legacy still plays some role but impact is not so high.<br />
</p><p>Having a new technologies on board simply makes developers happier. Happy developer is obsessed developer, he is commited to success. He will work as much as he can to make good results. <br />
</p><p>With a consistent challenge, every day is no longer &#8220;another day in office&#8221;, but rather &#8220;yet another day on pirate ship&#8221;. It starts to smell start-up shop, that tried to get on market as soon as possible, adapting last available tools. The project now is not something I just had to do, but kind of pet project, where you trying things out and feel great if those things works.<br />
</p><p>That&#8217;s why in particular I think it is great to start from scratch (or near to scratch) one a year or something. Pick up last thing, learn them, adopt and build something valuable - it is nothing to compare with maintenance of 5 year old code.<br />
</p><p>New technologies moves you product faster!<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/12/elmah-mvc-answering-questions.html">
    
      ELMAH MVC: Answering questions</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-12-11T12:25:00+02:00" pubdate data-updated="true">Dec 11<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/elmah-dot-mvc/'>ELMAH.MVC</a>, <a class='category' href='/blog/categories/mvc/'>MVC</a>, <a class='category' href='/blog/categories/nuget/'>NuGet</a>, <a class='category' href='/blog/categories/tools/'>Tools</a>, <a class='category' href='/blog/categories/asp-dot-net/'>asp.net</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>I&#8217;ve received some questions recently regarding <a href="https://nuget.org/packages/Elmah.MVC">ELMAH.MVC</a> nuget package. Here is the summary blog post and I hope it is helpful.<br />
</p><h2>How to change that to log it into a database?</h2><p>Indeed, the demo project on a <a href="https://github.com/alexanderbeletsky/elmah.mvc.controller/blob/master/src/Web.config">github</a> uses simple <code>Elmah.MemoryErrorLog</code> just holding all errors in session. That works great for small application or just to try out things. In reallity you need some persistant storage, like files or database. And this is extreamly easy to do. Take a look at this section of web.config:<br />
</p><pre class="brush: xml">&lt;elmah&gt;
    &lt;security allowRemoteAccess=&quot;yes&quot; /&gt;
    &lt;errorLog type=&quot;Elmah.MemoryErrorLog, Elmah&quot;/&gt;
    &lt;!--&lt;errorLog type=&quot;Elmah.SqlErrorLog, Elmah&quot; connectionStringName=&quot;elmah&quot; /&gt;--&gt;
    &lt;!--&lt;errorLog type=&quot;Elmah.XmlFileErrorLog, Elmah&quot; logPath=&quot;~/App_Data/Elmah.Errors&quot; /&gt;--&gt;
&lt;/elmah&gt;
</pre><p>Just comment out <code>Elmah.MemoryErrorLog</code> and de-comment <code>Elmah.SqlErrorLog</code> (will store errors to SQL database) or <code>Elmah.XmlFileErrorLog</code> (will store errors to XML files). XML logger, just requires a virtual path to folder there files will be stored. Sql logger, requires a connection string name for ELMAH database. The same web.config contains:<br />
</p><pre class="brush: xml">&lt;connectionStrings&gt;
    &lt;add name=&quot;elmah&quot; connectionString=&quot;Data Source=.\SQLEXPRESS;Initial Catalog=elmah;Integrated Security=True&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt;
&lt;/connectionStrings&gt;
</pre><p>The database have to have ELMAH schema inside. It is very easy to prepare that schema, just run <a href="https://github.com/alexanderbeletsky/elmah.mvc.controller/blob/master/db/database.sql">this</a> SQL script against database you want to keep errors to.<br />
</p><h2>Does ELMAH.MVC handle custom error pages?</h2><p>This is a misconception. ELMAH.MVC is not about custom pages, at all. This is good answer on <a href="http://stackoverflow.com/a/1288819/386751">stackoverflow</a> on that. For a code example, you can refer to something I did for before my projects just <a href="https://github.com/alexanderbeletsky/trackyt.net/blob/master/src/Web/Controllers/ErrorController.cs">here</a><br />
</p><h2>ELMAH.MVC gives me FxCop/StyleCop issues?</h2><p>I&#8217;ve received <a href="https://github.com/alexanderbeletsky/elmah.mvc.controller/issues/4">that</a> kind report on github issues. Initially I thought to do something about it but then I left that idea. The explanation is inside the ticket.<br />
</p><p>Short answer is, ELMAH.MVC is nothing more that boilerplate code. As soon as you can see it work and it works OK for you, adopt it for your custom needs. That&#8217;s it.<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/12/approval-tests-alternative-view-on-test.html">
    
      Approval Tests, Alternative View on Test Automation</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-12-11T01:19:00+02:00" pubdate data-updated="true">Dec 11<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/approvals/'>Approvals</a>, <a class='category' href='/blog/categories/open-source/'>Open source</a>, <a class='category' href='/blog/categories/tdd/'>TDD</a>, <a class='category' href='/blog/categories/tools/'>Tools</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p><a href="https://sourceforge.net/projects/approvaltests/">Approval Tests</a> or simply Approvals in a framework created by <a href="http://twitter.com/#!/LlewellynFalco">Llewellyn Falco</a> and <a href="http://dangilkerson.users.sourceforge.net/">Dan Gilkerson</a>, providing support for .NET, Java, PHP and Ruby. It is not yet another unit testing framework like NUnit or MbUnit etc., instead those frameworks are used to run approval tests.<br />
</p><p>Broadly speaking, software is nothing more as virtual box there we put some inputs and expect on outputs. The outputs could be produces by zillion ways. Those ways are differ by its implementation. Unit tests are too much focusing on implementation. Thats why unit tests might fail even if you have working code, or otherwise. Approvals are focusing on output.<br />
</p><h2>How it works?</h2><p>Let&#8217;s take a look on a very simple case. Say, I have a class <code>ShoppingCart</code>. I can add some products inside the shopping cart, confirm my purchase. I expect that total price is calculated for me. <br />
</p><pre class="brush: csharp">[TestFixture]
[UseReporter(typeof(DiffReporter))]
public class ShoppingCartTests {

    [Test]
    public void should_calculate_the_total_price_for_shopping_cart() {
        // do
        var shoppingCart = new ShoppingCart();
        shoppingCart.Add(new Product { Id = "iPad", Price = 500 });
        shoppingCart.Add(new Product { Id = "Mouse", Price = 20 });
        shoppingCart.Confirm();

        // verify
        Approvals.Approve(shoppingCart);
    }
}
</pre><p>What happens if I run this test? If I&#8217;m running it first time it fails. No matter it works or doesn&#8217;t. Framework simply don&#8217;t know that yet. To understand how much correct that code is, it will actually ask you, to utilized human primary power - recognition.   <br />
</p><p>In that case it will open the TortoiseDiff application and show actual and expected outputs.<br />
</p><a href="https://lh5.googleusercontent.com/-la_QjhoPxSc/TuPoxAXVteI/AAAAAAAAH0w/MdWZ0OAcalk/s779/Diff.jpg"><br />
<img src="https://lh5.googleusercontent.com/-la_QjhoPxSc/TuPoxAXVteI/AAAAAAAAH0w/MdWZ0OAcalk/s779/Diff.jpg" /><br />
</a><br />
<p>Here, I&#8217;m able just read that: &#8220;Ok, I have 2 products in my cart..one iPod and one Mouse, iPods costs 500 smth and mouse is 20 smth.. and the total price is 520 - looks good! I approve that result!&#8221;.<br />
</p><p>Technically the approving is just copying actual output file to expected. As soon as test passed, actual file output is deleted and approved file resides near test code file, so you just check it in source control.<br />
</p><p>If then the shopping cart is modified and something goes wrong. There would be a failure. In case of unit tests, that would be multiple failure of different cases and it might be not so easy to understand what&#8217;s exactly wrong. For approval test, it would be one failure. And the cool thing that I have a difference that shows there exactly the deviation is. <br />
</p><a href="https://lh3.googleusercontent.com/-CTO2HOQGoDs/TuPo7nJ1U8I/AAAAAAAAH04/ycao7SUf78s/s720/Diff2.jpg"><br />
<img src="https://lh3.googleusercontent.com/-CTO2HOQGoDs/TuPo7nJ1U8I/AAAAAAAAH04/ycao7SUf78s/s720/Diff2.jpg" /><br />
</a><br />
<h2>Where it works?</h2><p>It is not only the simple objects you can approve. What&#8217;s the cool thing, you can approval against the different sources: objects, enumerables, files, HTML, XML etc. On a more high level: WpfForm, WinForm, ASP.NET Page. <br />
</p><p>For instance, code for ASP.NET:<br />
</p><pre class="brush: csharp">[Test]
public void should_have_approved_layout() {
    ApprovalTests.Asp.Approvals.ApproveUrl("http://localhost:62642/customer/");
}
</pre><p>Or for WPF form<br />
</p><pre class="brush: csharp">[Test]
public void should_have_approved_layout() {
    ApprovalTests.Wpf.Approvals.Approve(new Form());
}
</pre><p>With WPF and Win forms is that it&#8217;s able to serialize them into images, so the actual and expected results are actually images, so it is easy to track the differences (TortoiseDiff can do that).<br />
</p><h2>When it works?</h2><p>It works best when you deal with 2 things: UI and legacy code.<br />
</p><p>Testing of UI is always a difficult part. But what you typically need is: make sure that UI is not changed and if changed, where exactly is happening. Apporvals solves that nicely. It is only one line of code test, to test ASP.NET page for instance. <br />
</p><p>Legacy is another story: you have no tests there at all, but you have to change code to implement new feature or refactor. The interesting thing about legacy code - It works! It works for years, no matter how it written (remember, virtual box). And this is a very great advantage of that code. With approvals, with only one test you can get all possible outputs (HTML, XLM, JSON, SQL or whatever output it could be) and approve, because you know - it works! After you have such test and approved result you are really much safe with a refactoring, since now you &#8220;locked down&#8221; all existing behavior.<br />
</p><p>Approvals are not something you need to run all the time, like units or integration tests. It more like handy tool. You create approval tests, you do your job and at the end of the day it might happen - you no longer needed, so you can just throw it away.<br />
</p><h2>Want to hear more?</h2><p>Just go and listen to <a href="http://herdingcode.com/?p=329">this</a> Herding Code podcast episode, or visit project <a href="https://sourceforge.net/projects/approvaltests/">web site</a> or join me at 17 December on <a href="http://xpdays.com.ua/program/">XP Days Ukraine</a> conference in Kiev, where I&#8217;m going to have a speech dedicated to Approvals.<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/12/inside-aspnet-mvc-instantiation-of.html">
    
      Inside ASP.NET MVC: Instantiation of Controller</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-12-05T21:05:00+02:00" pubdate data-updated="true">Dec 5<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/insidemvc/'>InsideMVC</a>, <a class='category' href='/blog/categories/mvc/'>MVC</a>, <a class='category' href='/blog/categories/asp-dot-net/'>asp.net</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>Controller are being created by <code>ControllerFactory</code>, by default <code>IControllerFactory</code> type is being resolved to <code>DefaultControllerFactory</code>. Today&#8217;s post is dedicated to some details of how actually <code>DefaultControllerFactory</code> works and creates instance of required controller. Let&#8217;s go from the beginning!<br />
</p><h2>Request for controller instance</h2><p>Initially, we are at <a href="http://www.beletsky.net/2011/06/inside-aspnet-mvc-all-begins-here.html">MvcHandler</a>&#8217;s <code>ProcessRequestInit</code> method, where we extract controllers name from RouteData and request controller factory to create corresponding controller.<br />
</p><pre class="brush: csharp">private void ProcessRequestInit(HttpContextBase httpContext, out IController controller, out IControllerFactory factory) {
 // If request validation has already been enabled, make it lazy. This allows attributes like [HttpPost] (which looks
 // at Request.Form) to work correctly without triggering full validation.
 bool? isRequestValidationEnabled = ValidationUtility.IsValidationEnabled(HttpContext.Current);
 if (isRequestValidationEnabled == true) {
  ValidationUtility.EnableDynamicValidation(HttpContext.Current);
 }

 AddVersionHeader(httpContext);
 RemoveOptionalRoutingParameters();

 // Get the controller type
 string controllerName = RequestContext.RouteData.GetRequiredString(&quot;controller&quot;);

 // Instantiate the controller and call Execute
 factory = ControllerBuilder.GetControllerFactory();
 controller = factory.CreateController(RequestContext, controllerName);
 if (controller == null) {
  throw new InvalidOperationException(
   String.Format(
    CultureInfo.CurrentCulture,
    MvcResources.ControllerBuilder_FactoryReturnedNull,
    factory.GetType(),
    controllerName));
 }
}
</pre><h2>DefaultControllerBuilder internals<br />
</h2><p><code>CreateController</code> is rather elegant method, basically it does some arguments check&#8217;s, resolve the controller type by it&#8217;s name and then call to <code>GetControllerIntance</code> to instantiate that type.<br />
</p><pre class="brush: csharp">public virtual IController CreateController(RequestContext requestContext, string controllerName) {
 if (requestContext == null) {
  throw new ArgumentNullException(&quot;requestContext&quot;);
 }
 if (String.IsNullOrEmpty(controllerName)) {
  throw new ArgumentException(MvcResources.Common_NullOrEmpty, &quot;controllerName&quot;);
 }
 Type controllerType = GetControllerType(requestContext, controllerName);
 IController controller = GetControllerInstance(requestContext, controllerType);
 return controller;
}
</pre><h2>Getting the controller type</h2><p><code>GetControllerType</code> is delegating it&#8217;s call to internal <code>GetControllerTypeWithinNamespaces</code>. It receives Route, Controller&#8217;s name and Namespaces.  <br />
</p><pre class="brush: csharp">private Type GetControllerTypeWithinNamespaces(RouteBase route, string controllerName, HashSet&lt;string&gt; namespaces) {
 // Once the master list of controllers has been created we can quickly index into it
 ControllerTypeCache.EnsureInitialized(BuildManager);

 ICollection&lt;Type&gt; matchingTypes = ControllerTypeCache.GetControllerTypes(controllerName, namespaces);
 switch (matchingTypes.Count) {
  case 0:
   // no matching types
   return null;

  case 1:
   // single matching type
   return matchingTypes.First();

  default:
   // multiple matching types
   throw CreateAmbiguousControllerException(route, controllerName, matchingTypes);
 }
}
</pre><p>The namespaces parameter are quite important. If you remember, you can explicitly mention the namespace during the route definition, with overloaded MapRoute method:<br />
</p><pre class="brush: csharp">public static Route MapRoute(this RouteCollection routes, string name, string url, string[] namespaces) {
 return MapRoute(routes, name, url, null /* defaults */, null /* constraints */, namespaces);
}
</pre><p>Namespaces parameter then being stored to Route.DataTokens[&#8220;Namespaces&#8221;]. Namespaces parameter matters, then you have controllers with same names. This is in particular makes sense then you have different areas.<br />
</p><h2>Caching Controller Types</h2><p>The interesting thing is that framework not re-reads types for each request, that would be just to expesive, but instead it uses a cache which is initialized at the very first request and used at the life time of application. The call <code>ControllerTypeCache.EnsureInitialized(BuildManager);</code> makes sure that cache is in actual state. How does MVC caching the types?<br />
</p><p>Very simple and straight forward solution - in .XML file.<br />
</p><pre class="brush:csharp">public static List&lt;Type&gt; GetFilteredTypesFromAssemblies(string cacheName, Predicate&lt;Type&gt; predicate, IBuildManager buildManager) {
 TypeCacheSerializer serializer = new TypeCacheSerializer();

 // first, try reading from the cache on disk
 List&lt;Type&gt; matchingTypes = ReadTypesFromCache(cacheName, predicate, buildManager, serializer);
 if (matchingTypes != null) {
  return matchingTypes;
 }

 // if reading from the cache failed, enumerate over every assembly looking for a matching type
 matchingTypes = FilterTypesInAssemblies(buildManager, predicate).ToList();

 // finally, save the cache back to disk
 SaveTypesToCache(cacheName, matchingTypes, buildManager, serializer);

 return matchingTypes;
}
</pre><p>It try&#8217;s read cache from file, if there are not matching types there it would try to read assemblies and then store it to cache. You might be interested where this file is actually located, so take a look:<br />
</p><a href="https://lh4.googleusercontent.com/-UkykIJvxzV8/Tt0WMwVDXsI/AAAAAAAAH0o/hgnCXDEYvmY/s848/code_1.jpg"><br />
<img src="https://lh4.googleusercontent.com/-UkykIJvxzV8/Tt0WMwVDXsI/AAAAAAAAH0o/hgnCXDEYvmY/s848/code_1.jpg" alt="cache file name" /><br />
</a><br />
<p>And for the most curious guys, here is the content:<br />
</p><pre class="brush: xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;!--This file is automatically generated. Please do not modify the contents of this file.--&gt;
&lt;typeCache lastModified=&quot;14.10.2011 19:33:03&quot; mvcVersionId=&quot;aa5414f4-4d8e-4f2a-a98b-7334bf15d104&quot;&gt;
  &lt;assembly name=&quot;MvcForDebug2, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;&gt;
    &lt;module versionId=&quot;1ad99820-dc17-4be0-9f56-6dd2bdcd7950&quot;&gt;
      &lt;type&gt;MvcForDebug2.Controllers.HomeController&lt;/type&gt;
    &lt;/module&gt;
  &lt;/assembly&gt;
&lt;/typeCache&gt;
</pre><p><code>FilterTypesInAssemblies</code> method tries to get all controllers it can. What it does, it goes throught all referenced assemblies and using special predicate class matching the types. <br />
</p><pre class="brush:csharp">private static IEnumerable&lt;Type&gt; FilterTypesInAssemblies(IBuildManager buildManager, Predicate&lt;Type&gt; predicate) {
 // Go through all assemblies referenced by the application and search for types matching a predicate
 IEnumerable&lt;Type&gt; typesSoFar = Type.EmptyTypes;

 ICollection assemblies = buildManager.GetReferencedAssemblies();
 foreach (Assembly assembly in assemblies) {
  Type[] typesInAsm;
  try {
   typesInAsm = assembly.GetTypes();
  }
  catch (ReflectionTypeLoadException ex) {
   typesInAsm = ex.Types;
  }
  typesSoFar = typesSoFar.Concat(typesInAsm);
 }
 return typesSoFar.Where(type =&gt; TypeIsPublicClass(type) &amp;&amp; predicate(type));
}
</pre><p>So, the last interesting thing here is the predicate that actually used:<br />
</p><pre class="brush:csharp">internal static bool IsControllerType(Type t) {
 return
  t != null &amp;&amp;
  t.IsPublic &amp;&amp;
  t.Name.EndsWith(&quot;Controller&quot;, StringComparison.OrdinalIgnoreCase) &amp;&amp;
  !t.IsAbstract &amp;&amp;
  typeof(IController).IsAssignableFrom(t);
}
</pre><p>You can see, it tries to match any public, ends with &#8220;Controller&#8221; not abstract and implementing <code>IController</code> interface. That&#8217;s why important do not forget to call all your controller with &#8220;Controller&#8221; suffix (yes, I did that mistake several times in the beginning of my MVC journey).<br />
</p><p>Note, that if you have 2 controllers with same names in different namespaces, but did not provide namespace constraint you will have several <code>matchingTypes</code>, so the <code>CreateAmbiguousControllerException</code> will be thrown. I believe each of us seen that kind of exception at least once.<br />
</p><h2>Instantiating the Type</h2><p>As we go a little back and check the code of <code>CreateController</code>: now, we&#8217;ve got the type (or null if type has not been resolved). Next thing is to instantiate it. Nothing really fancy here:<br />
</p><pre class="brush:csharp">protected internal virtual IController GetControllerInstance(RequestContext requestContext, Type controllerType) {
 if (controllerType == null) {
  throw new HttpException(404,
   String.Format(
    CultureInfo.CurrentCulture,
    MvcResources.DefaultControllerFactory_NoControllerFound,
    requestContext.HttpContext.Request.Path));
 }
 if (!typeof(IController).IsAssignableFrom(controllerType)) {
  throw new ArgumentException(
   String.Format(
    CultureInfo.CurrentCulture,
    MvcResources.DefaultControllerFactory_TypeDoesNotSubclassControllerBase,
    controllerType),
   &quot;controllerType&quot;);
 }
 return ControllerActivator.Create(requestContext, controllerType);
}
</pre><p>If everything is all right with controller type it ask ControllerActivator to create the instance. In default case, ControllerActivator is <code>DefaultControllerActivator</code>:<br />
</p><pre class="brush:csharp">public IController Create(RequestContext requestContext, Type controllerType) {
 try {
  return (IController)(_resolverThunk().GetService(controllerType) ?? Activator.CreateInstance(controllerType));
 }
 catch (Exception ex) {
  throw new InvalidOperationException(
   String.Format(
    CultureInfo.CurrentCulture,
    MvcResources.DefaultControllerFactory_ErrorCreatingController,
    controllerType),
   ex);
 }
}
</pre><p>As for the rest of MVC entities it would use <code>IDependencyResolver</code> to resolve that type. <code>IDependecyResolved</code> is detailed <a href="http://www.beletsky.net/2011/10/inside-aspnet-mvc-idependencyresolver.html">here</a>, but as you remember by default at the very end it calls <code>Activator.CreateInstance(type)</code> method.<br />
</p><h2>Conclusions</h2><p>New controller is instantiated on each HTTP request. The instantiation is in-directed, means first we retrieve Type, after creating Instance. The type is being searched dynamically by getting out reflection information from assemblies. To optimize the performance of ASP.NET MVC application, the internal cache of types is used. The cache is stored in file in &#8220;Temporary ASP.NET Files\root\cdd53039\36a27802\UserCache\MVC-ControllerTypeCache.xml&#8221; folder. Namespaces of controllers are matters, in case of two or more controllers has the same name but different namespaces the exception would be thrown. In case of controller type could not be resolved, the HTTP 404 response is generated. Otherwise, the controller instance would be created by <code>IControllerActivator</code> instance.<br />
</p><p>Previous post: <a href="http://www.beletsky.net/2011/10/inside-aspnet-mvc-idependencyresolver.html">Inside ASP.NET MVC: IDependencyResolver - Service locator in MVC</a><br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/12/kiev-altnet-community-thoughts.html">
    
      Kiev ALT.NET Community Thoughts</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-12-03T11:52:00+02:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/kievaltnet/'>KievAltNet</a>, <a class='category' href='/blog/categories/mind/'>Mind</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>I&#8217;ve just reviewed blog posts I created thought that year and realized that I miss very important piece of information here. Something that literally changed my developers life. And I&#8217;m talking about <a href="http://kievalt.net/">Kiev ALT.NET</a> community.<br />
</p><p>From my first join at the beginning of the year I amazed with very cool and friendly atmosphere there. I tried to visit every meeting and each of them brought some value for me. And the most valuable asset I got there is people I met. Those guys simply rock.<br />
</p><a href="https://lh4.googleusercontent.com/-3_a5l569SpU/TtnvsnVAekI/AAAAAAAAH0g/gQeYOduVHZM/s512/kiev.jpg"><br />
<img src="https://lh4.googleusercontent.com/-3_a5l569SpU/TtnvsnVAekI/AAAAAAAAH0g/gQeYOduVHZM/s512/kiev.jpg" alt="kiev alt.net" /><br />
</a><br />
<p><a href="http://twitter.com/chaliy">Mike Chaliy</a>, the leader of community does exceptional job. I could imagine how hard could it be to do all organization work and he does that very well. <br />
</p><p>What&#8217;s important, Mike involved me to do my own speech. I remember that first time when I was sharing my experience with <a href="http://www.beletsky.net/2011/05/continuous-production-make-it-work.html">Continues Deployment</a> based on Chuck Norris tools and Jenkins. That was a good start and I did several more speeches after. I would say it happened only because of Kiev ALT.NET.<br />
</p><p>Getting of knowledge for me is not only books, podcasts and just coding practice. But also, discussions, questions and speeches. I this is definitely productive way of learning. <br />
</p><p>So, I&#8217;m very thankful to Kiev ALT.NET for that positive feel of progress, pleasure of communication with smart guys and fun time of after parties.I wish a long life for community and try to help it as much as I can.<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/11/develop-with-tests.html">
    
      Develop With Tests</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-11-16T18:10:00+02:00" pubdate data-updated="true">Nov 16<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/tdd/'>TDD</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>I&#8217;ve been recently thinking about my TDD and I came to interesting conclusion.  I&#8217;m not TDD practitioner any more!<br />
</p><p>TDD is quite strict  practice, it suppose you following certain rules. The main rule is test first. You create test, you create code after. For years I&#8217;ve been using that practice as dogma. I&#8217;ve seen a lot of value with such approach and that worked for me really much. <br />
</p><p>Do you use that rules now? Not always.. Do you use something different than TDD? Yes, I do <strong>develop with tests</strong>.<br />
</p><p>See, TDD main power is not in tests itself. The power of TDD is Test Driven Design. This is design that makes code more readable and maintainable. Tests of cause helps regression and general quality, but it is not always the truth. As long as you practice TDD much you feel how designed for tests code should look like. You do not need to create test to prove that code is testable. Following very simple rules you simply guarantee that tests are possible here. <br />
</p><p>Now, I simply optimize the process a bit. I could skip first step and go ahead for code. That does not mean I&#8217;m skipping test. No, I&#8217;ll create there I feel it necessary.. And I feel that mostly to all code I create. But this is no longer TDD, I call that develop with tests. DWT as you want ;)<br />
</p><a href="https://lh3.googleusercontent.com/-wRTF3X1cJm0/TsPgJH6ryEI/AAAAAAAAH0M/H51scOr_Gf8/s620/dwt.jpg"><br />
<img src="https://lh3.googleusercontent.com/-wRTF3X1cJm0/TsPgJH6ryEI/AAAAAAAAH0M/H51scOr_Gf8/s620/dwt.jpg" alt="develop with tests" /><br />
</a><br />
<p>I think a some developers might say, &#8220;Oh, I&#8217;m using DWT as well&#8221;. Others will say, &#8220;I will use DWT since TDD is boring and requires too much time&#8221;. Please do not do that. I strongly believe that is TDD that could make you stronger as developers and your code robust and good looking. So follow the rules before you absolutely sure, you ready to break them.<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/11/its-writing-time.html">
    
      It&#8217;s Writing Time</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-11-14T10:10:00+02:00" pubdate data-updated="true">Nov 14<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/mind/'>Mind</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>There are great series of stories called <a href="http://en.wikipedia.org/wiki/Azazel_(Asimov)">&#8220;Azazel&#8221;</a> by <a href="http://en.wikipedia.org/wiki/Isaac_Asimov">Isaac Asimov</a>. They are about 2 cm demon named Azazel and George, guy who is able to talk to him. Azazel knows actually nothing about demons or angels, hell or haven.. But he understands the nature of things able to change them. The stories are short and fun and smart, so I would recommend it to read.<br />
</p><p>In particular, there is one great story called &#8220;Writing time&#8221;. It&#8217;s about the man whose name is Mordehai and he is writer. He has a great issue. He always need to wait for something, like wait for doctors, waiters, cab drivers, wait in a shop lines etc. Mordehai treated that time as completely wasted, because he could not spent it for job.<br />
</p><p>He shared that problem with George. George asked Azazel if it&#8217;s possible to help to poor Mordehai. As always Azazel was angry about peoples misery, but agreed to help. He could introduce change that make it possible to Mordehai never need to wait for somebody. That change required a little cost, literally the sun will stop shining in 2 million years earlier, but who cares.<br />
</p><p>George met Mordehai again in several month. For his great disappointment, writer created simply nothing in that time! Not even a small story. Instead of being hyper productive he became non productive at all.<br />
</p><p>How could it be, that person who spend all his time for work are not able to do the work? As Mordehai understood as he sat behind his type writer - he had no ideas. Simply, he don&#8217;t know what to write about. <br />
</p><p>As it turned out all that time he waited actually spent for thinking. It was absolutely not a waste for him, otherwise it was the most productive time.. But he did not realized that before. Unfortunately, Mordehai&#8217;s career totally ruined. <br />
</p><p>You know what? I think that I&#8217;m wasting the time instead of doing &#8220;cool things&#8221;. I work as hard as I can, but the results aren&#8217;t impressive. I neither could find good idea nor have good rest recently - I&#8217;m exactly like Mordehai who blames waiting line for his problems.<br />
</p><p>I&#8217;ll try not to repeat this issue. Having a rest, spending time with family or sport activities are equally important as job (perhaps even more important). And even if you are &#8220;doing nothing&#8221;, something is still going on your head. If inputs are right, outputs will be right as well.. Sooner or later.<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/11/sayonara-nippon.html">
    
      Sayonara Nippon</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-11-12T21:34:00+02:00" pubdate data-updated="true">Nov 12<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/life/'>Life</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>I&#8217;ve just got back from the most wonderful country I ever been to - Japan. <br />
</p><a href="https://lh5.googleusercontent.com/-JQHNK-xBJqE/Tr7JuF_SRNI/AAAAAAAAHzk/UsxHzEvgek8/s620/Gates.jpg?gl=UA"><br />
<img src="https://lh5.googleusercontent.com/-JQHNK-xBJqE/Tr7JuF_SRNI/AAAAAAAAHzk/UsxHzEvgek8/s620/Gates.jpg?gl=UA" alt="japan gates" /><br />
</a><br />
<p>Japan is really different from everything I got used to. Differences are everywhere, from traffic direction to people behavior. But in general Japan is well developed, high cultural country with interesting history.<br />
</p><p>Tokyo is huge, but the same is <a href="http://www.tokyometro.jp/en/">Tokyo Metropolitan</a> which is really complex, but makes travel from one part of city to another very fast. First day we have a lot of problems to understand metropolitan labyrinths, but with a little practice it does not look so scary anymore. Btw, I&#8217;ve never seen very over crowded stations and trains, even if you travel in rush hour. Comparing to Kyiv metro, Tokyo one is very expensive, where you pay as much as you go.  <br />
</p><a href="https://lh4.googleusercontent.com/-MSLfarHSstA/Tr7Jv5PqImI/AAAAAAAAHzs/nSskJV4W5Ac/s620/metro.JPG?gl=UA"><br />
<img src="https://lh4.googleusercontent.com/-MSLfarHSstA/Tr7Jv5PqImI/AAAAAAAAHzs/nSskJV4W5Ac/s620/metro.JPG?gl=UA" alt="tokyo metropolitan" /><br />
</a><br />
<p>People there are very kind, ready to help you. But the problem is communication. Very few Japanese can speak English. Usual dialog is something like. &#8220;Do you speak English?&#8221;, &#8220;A little..&#8221; and then nothing, even if you try to use as elementary words as possible. So, language barrier is very high. But as soon as they understood your problem, be sure you gonna get help. Once we&#8217;ve lost in metropolitan and one lady went out from station with ask, contacted metropolitan officer and explained our further actions. Such scenario happened several times.<br />
</p><a href="https://lh6.googleusercontent.com/-Yzz0uvSJ0Rc/Tr7JtvG9fkI/AAAAAAAAHzc/Vh8w20Qfjbc/s620/food.JPG?gl=UA"><br />
<img src="https://lh6.googleusercontent.com/-Yzz0uvSJ0Rc/Tr7JtvG9fkI/AAAAAAAAHzc/Vh8w20Qfjbc/s620/food.JPG?gl=UA" alt="noodles" /><br />
</a><br />
<p>Food is very delicious and relatively not expensive. Chinese and Japanese dishes are usually available together in restaurants. But if you want to go with sushi, you have to find specialized one. There are absolutely not a problem to eat in Tokyo. In each corner you could find small restaurants and cafeterias where you will be able to find what you like. Food is available mostly everywhere, including metro stations.     <br />
</p><a href="https://lh6.googleusercontent.com/-oPJTvUilLkA/Tr7JxUvajTI/AAAAAAAAHz0/ipwdXzxSFcE/s620/tree.JPG?gl=UA"><br />
<img src="https://lh6.googleusercontent.com/-oPJTvUilLkA/Tr7JxUvajTI/AAAAAAAAHz0/ipwdXzxSFcE/s620/tree.JPG?gl=UA" alt="tokyo park" /><br />
</a><br />
<p>Tokyo is concrete and wires jungle, but there are several great parks inside. They are beauty and calm. It is easy to find a bench to sit and observe spectacular views. It is great to relax body and mind there.<br />
</p><p>I would not say I&#8217;ve seen a lot, but I really enjoyed with everything I saw. <br />
</p><p>Sayonara Nippon! Hope to visit you again in a while.. Best luck to you!<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/10/using-ninjectmvc-for-better-aspnet-mvc.html">
    
      Using Ninject.MVC For Better ASP.NET MVC Integration</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-10-31T16:42:00+02:00" pubdate data-updated="true">Oct 31<span>st</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/mvc/'>MVC</a>, <a class='category' href='/blog/categories/asp-dot-net/'>asp.net</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>After the ASP.NET MVC infrastructure is <a href="http://www.beletsky.net/2011/10/integrating-aspnet-mvc-into-legacy-web.html">ready</a>, next logical step it to setup IoC container for application. Ninject setup is easy task, usually you solve that by implementation of your own <a href="http://www.beletsky.net/2011/07/inside-aspnet-mvc-controllerbuilder.html">ControllerFactory</a> and put it to <a href="http://www.beletsky.net/2011/07/inside-aspnet-mvc-controllerbuilder.html">ControllerBuilder</a>. As soon it is good enough approach it does not solve some important MVC implications, like injection of prosperities into filters. To make our lives a little easier Ninject team released <a href="https://github.com/ninject/ninject.web.mvc">Ninject.Web.MVC</a> extension library that solves a lot of similar problems.<br />
</p><h2>Getting binaries</h2><p>Just follow the github to <a href="https://github.com/ninject/ninject.web.mvc/downloads">download</a> latest version of Ninject.Web.MVC and place it to web site <code>/Bin</code> directory. No changes to <code>web.config</code> or something.<br />
</p><h2>Tweaking global.asax</h2><p>Now, let&#8217;s change <code>global.asax</code> according to Ninject.Web.MVC guidelines. I&#8217;ll just show how my current <code>global.aspx</code> looks like:<br />
</p><pre class="brush: xml">&lt;%@ Application Language='C#' Inherits=&quot;Ninject.Web.Mvc.NinjectHttpApplication&quot; %&gt;
&lt;%@ Import Namespace=&quot;Ninject&quot; %&gt;

&lt;script RunAt=&quot;server&quot;&gt;
 public void Application_Start()
 {

 }

 protected override void OnApplicationStarted()
 {
  AreaRegistration.RegisterAllAreas();
 }
 
 protected override IKernel CreateKernel()
 {
  var kernel = new StandardKernel();
  Sba.Web.Infrastructure.RegisterServices.For(kernel);
  
  return kernel;
 }

 public void Application_End()
 {
 }

 public void Application_Error(object sender, EventArgs args)
 {
 }
&lt;/script&gt;
</pre><p>So, we basically inherit from <code>NinjectHttpApplication</code> class and override <code>CreateKernel()</code> method. You can see that inside the method I do call to <code>RegisterServices</code> - it is nothing more as static class, with <code>For</code> method that actually do the registration. Here is example:<br />
</p><pre class="brush: csharp">using Ninject;
using Ninject.Web.Mvc;
using Sba.Common.Repositories;
using Sba.Sales.Models;
using Sba.Sales.Repositories;
using Sba.Sales.Repositories.ViewHandlerRepositories;

namespace Sba.Web.Infrastructure
{
 public class RegisterServices
 {
  public static void For(IKernel kernel)
  {
   kernel.Bind&lt;ISessionLoader&gt;().To&lt;LazySessionLoader&gt;();
   kernel.Bind&lt;ILazyLoadChecker&gt;().To&lt;NHibernateLazyLoadChecker&gt;();
   kernel.Bind&lt;IDraftInvoicesRepository&gt;().To&lt;DraftInvoicesRepository&gt;();
   kernel.Bind&lt;IDraftInvoiceLinesRepository&gt;().To&lt;DraftInvoiceLinesRepository&gt;();
   kernel.Bind&lt;IPaymentTermsRepository&gt;().To&lt;PaymentTermsRepository&gt;();
   kernel.Bind&lt;IUnitsRepository&gt;().To&lt;UnitsRepository&gt;();
   kernel.Bind&lt;ICustomersRepository&gt;().To&lt;CustomersRepository&gt;();
  }
 }
}
</pre><h2>Injection the properties into filters</h2><p>The main advantage of <code>NinjectHttpApplication</code> class usage, that now it handles the injection in different MVC entities by itself. For instance if you need inject to filter:<br />
</p><pre class="brush: csharp">using System.Web.Mvc;
using Ninject;
using Economic2.Core;
using Sba.Common.Repositories;

namespace Sba.Common.Infrastructure.Filters
{
 public class SbaAuthorizeAttribute : AuthorizeAttribute
 {
  [Inject]
  public ISessionLoader SessionLoader { get; set; }

  public override void OnAuthorization(AuthorizationContext filterContext)
  {
            // some authorization logic here..
  }
 }
}
</pre></div>

      
      
    </div>
  </div>

    </article>
  
  
    <article>
        
  <h1 class="title pure-u-1">
    
    <a href="/2011/10/integrating-aspnet-mvc-into-legacy-web.html">
    
      Integrating ASP.NET MVC Into Legacy Web Site</a>
  </h1>

  <div class="meta pure-u-1-5">
    <div class="date icon-calendar">








  


<time datetime="2011-10-30T09:05:00+02:00" pubdate data-updated="true">Oct 30<span>th</span>, 2011</time></div>
    <div class="tags icon-tag-2">

<span class="categories">
  
    <a class='category' href='/blog/categories/mvc/'>MVC</a>, <a class='category' href='/blog/categories/tips/'>Tips</a>, <a class='category' href='/blog/categories/asp-dot-net/'>asp.net</a>
  
</span>

</div>
  </div>

  <div class="entry-content pure-u-4-5">
    <div class="content">
      <div class='post'>
<p>For some quite long time I naively thought that it is not possible (or at least very difficult) to make ASP.NET MVC stuff work on a Web Site project. But, my latest <a href="http://www.beletsky.net/search/label/InsideMVC">hacking of MVC</a> opened another perspectives. There are no any difficulties with ASP.NET MVC on Web Sites. I&#8217;ll share an experience of integration ASP.NET MVC in my work project legacy Web Site.<br />
</p><h2>Pre-conditions</h2><p>In my case I integrated ASP.NET MVC2, since we are still running on .NET 3.5. If you are running .NET 4.0 the best is to go with ASP.NET MVC3 already. The difference of setup would not be huge, just in proper versions of assemblies.<br />
</p><p>I assume you already have ASP.NET MVC2 framework on your machine (if you have VS2010 - you definitely have one), if no just go that <a href="http://www.microsoft.com/download/en/details.aspx?displaylang=en&id=22079">link</a> and install it.<br />
</p><h2>Web config changes</h2><p>MVC assembly have to be added to <code>web.config</code>. Since the MVC infrastructure heavily depends on Routing mode, it have to be put to <code>web.config</code> as well.<br />
</p><p>Register MVC assemblies:<br />
</p><pre class="brush: xml">&lt;compilation defaultLanguage=&quot;c#&quot; debug=&quot;true&quot;&gt;
 &lt;assemblies&gt;
  &lt;add assembly=&quot;System.Core, Version=3.5.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089&quot;/&gt;
  &lt;add assembly=&quot;System.Web.Extensions, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
  &lt;add assembly=&quot;System.Data.DataSetExtensions, Version=3.5.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089&quot;/&gt;
  &lt;add assembly=&quot;System.Xml.Linq, Version=3.5.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089&quot;/&gt;
  &lt;add assembly=&quot;System.Design, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B03F5F7F11D50A3A&quot;/&gt;

  &lt;!-- Your application specific assemblies--&gt;
        ...

  &lt;!-- ASP.NET MVC --&gt;
  &lt;add assembly=&quot;System.Web.Abstractions, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
  &lt;add assembly=&quot;System.Web.Routing, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
  &lt;add assembly=&quot;System.Web.Mvc, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
 &lt;/assemblies&gt;
&lt;/compilation&gt;
</pre><p>Namespaces:<br />
</p><pre class="brush: xml">&lt;pages enableViewStateMac=&quot;false&quot; enableViewState=&quot;false&quot; validateRequest=&quot;true&quot; viewStateEncryptionMode=&quot;Never&quot;&gt;
  &lt;controls&gt;
    &lt;add tagPrefix=&quot;asp&quot; namespace=&quot;System.Web.UI&quot; assembly=&quot;System.Web.Extensions, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
    &lt;add tagPrefix=&quot;asp&quot; namespace=&quot;System.Web.UI.WebControls&quot; assembly=&quot;System.Web.Extensions, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;/&gt;
  &lt;/controls&gt;
  
  &lt;-- ASP.NET MVC --&gt;
  &lt;namespaces&gt;
    &lt;add namespace=&quot;System.Web.Mvc&quot;/&gt;
    &lt;add namespace=&quot;System.Web.Mvc.Ajax&quot;/&gt;
    &lt;add namespace=&quot;System.Web.Mvc.Html&quot;/&gt;
    &lt;add namespace=&quot;System.Web.Routing&quot;/&gt;
    &lt;add namespace=&quot;System.Linq&quot;/&gt;
    &lt;add namespace=&quot;System.Collections.Generic&quot;/&gt;
    &lt;add namespace=&quot;Microsoft.Web.Mvc&quot;/&gt;
  &lt;/namespaces&gt;
&lt;/pages&gt;
</pre><p>Register URLRouting module and handler.<br />
</p><pre class="brush: xml">&lt;system.webServer&gt;
  &lt;validation validateIntegratedModeConfiguration=&quot;false&quot;/&gt;
  &lt;modules&gt;
 ...
 
 &lt;!-- ASP.NET MVC --&gt;
    &lt;add name=&quot;UrlRoutingModule&quot; type=&quot;System.Web.Routing.UrlRoutingModule, System.Web.Routing, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot; /&gt;
  &lt;/modules&gt;
  &lt;handlers&gt;
    ...
 
 &lt;!-- ASP.NET MVC --&gt;
    &lt;add name=&quot;UrlRoutingHandler&quot; preCondition=&quot;integratedMode&quot; verb=&quot;*&quot; path=&quot;UrlRouting.axd&quot; type=&quot;System.Web.HttpForbiddenHandler, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot; /&gt;
  &lt;/handlers&gt;
&lt;/system.webServer&gt;
</pre><h2>Global.asax changes</h2><p>You would be probably have <code>global.asax</code> without code-behind class. It&#8217;s not a problem, all you need is slightly change the <code>Application_Start()</code> method. Basically you can go and register routes there, as you do in any ASP.NET MVC application. But I didn&#8217;t do that. Instead, I used the advantages of <a href="http://msdn.microsoft.com/en-us/library/ee671793.aspx">Areas</a> feature of MVC2, since it makes better logical grouping. So, my <code>global.asax</code> are:<br />
</p><pre class="brush: csharp">public void Application_Start()
{
 AreaRegistration.RegisterAllAreas();
}
</pre><h2>Models, Views, Controllers</h2><p>In typical ASP.NET MVC application you have 3 folders, for - Models, Views, Controllers. Models/Controllers are C# code, views are .aspx pages. With a Web Site you typically place code into <code>App_Code</code> folder. But you should not do that. Instead, it it better to create a separate class library project that would hold your models and controllers. Views would be placed under corresponding Area folder.<br />
</p><h2>New project for Models/Controllers</h2><p>Just create a new class library project with such folder structure:<br />
</p><a href="https://lh4.googleusercontent.com/-ny77OywB_Pk/Tqz2RrcVfCI/AAAAAAAAHnM/P2Awn0D79zc/s391/img-1.png"><br />
<img src="https://lh4.googleusercontent.com/-ny77OywB_Pk/Tqz2RrcVfCI/AAAAAAAAHnM/P2Awn0D79zc/s391/img-1.png" alt="asp.net mvc class library" /><br />
</a><br />
<p>The most important - it should contain Area Registration class inside. This is the one that suppose to register all router for your application:<br />
</p><pre class="brush: csharp">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web.Mvc;

namespace Sba.Web.Areas.Sales
{
 public class SalesAreaRegistration : AreaRegistration 
 {
  public override string AreaName
  {
   get 
   {
    return "Sales";
   }
  }

  public override void RegisterArea(AreaRegistrationContext context)
  {
            // All routes are here..

   context.MapRoute(
    "Sba_Sales",
    "sba/sales/{controller}/{action}/{id}",
    new { controller = "Home", action = "Index", id = UrlParameter.Optional }
   );
  }
 }
}
</pre><p>That&#8217;s it. Now you implement Controller/Models in usual way and able to add unit tests project for new assembly.<br />
</p><p>Make sure that assembly will be placed into to Web Site <code>/Bin</code> folder. I simply added <code>../Site/Bin</code> as project output directory. At the site initialization and <code>Application_Start()</code> call of Global.asax, all <code>AreaRegistration</code> instances would be created and routes being registered.<br />
</p><h2>Views</h2><p>Views have to be placed in the Web Site folder itself. MVC has several rules for views placements, so you have to follow them. Views for controllers that are part of Area&#8217;s have to be places into <code>Site/Areas/AreaName/Views</code>, the common stuff line master pages are in <code>Site/Views/Shared</code>. It is very important that each View folder must contain the <code>web.config</code> inside. You can either pick it up from default MVC2 application of just grab from <a href="https://gist.github.com/1325577">gist</a>.<br />
</p><a href="https://lh3.googleusercontent.com/-1oPOjbGMkIA/Tqz2Rs4oS6I/AAAAAAAAHnE/_jP0yI97UZg/s313/img-3.png"><br />
<img src="https://lh3.googleusercontent.com/-1oPOjbGMkIA/Tqz2Rs4oS6I/AAAAAAAAHnE/_jP0yI97UZg/s313/img-3.png" alt="views folder structure" /><br />
</a><br />
<h2>IIS configuration</h2><p>Our application previously worked in &#8220;Classic&#8221; mode. Even thought, it is possible to run MVC on &#8220;Classic&#8221; I would not really recommend it to do and if production environment allows, just switch you application pool to &#8220;Integrated mode&#8221;.   <br />
</p><a href="https://lh6.googleusercontent.com/-cgYuQPO2v3o/Tqz2Rho34dI/AAAAAAAAHnI/jP_SfDVxFcY/s349/img-2.png"><br />
<img src="https://lh6.googleusercontent.com/-cgYuQPO2v3o/Tqz2Rho34dI/AAAAAAAAHnI/jP_SfDVxFcY/s349/img-2.png" alt="iis application pool config" /><br />
</a><br />
<p>After you did it, you can go and run you application. If you setup basic Home controller and view, you should be able to access it by given route. If you receiving 403 HTTP error check:<br />
</p><ul><li>Are you really on integrated mode?</li>
<li>Are there any physical folders that the same as you routing, e.g /sba/sales route and /site/sba/sales folder? In such case you either should correct the routing or change site folder structure.</li>
</ul><h2>Session is Null issue</h2><p>Moving along and starting implementation of some real controllers, we&#8217;ve got very strange <code>NullReferenceException</code> problem. After bit debugging it turned out that <code>HttpContext.Current.Session</code> is null in controller actions. That&#8217;s the common problem for legacy web sites. It is very well described in this <a href="http://stackoverflow.com/questions/218057/httpcontext-current-session-is-null-when-routing-requests">stackoverflow</a> answer. So, you just need to add one more section into <code>web.config</code> file.<br />
</p><pre class="brush: xml">&lt;configuration&gt;
  ...
  &lt;system.webServer&gt;
    ...
    &lt;modules&gt;
      &lt;remove name=&quot;Session&quot; /&gt;
      &lt;add name=&quot;Session&quot; type=&quot;System.Web.SessionState.SessionStateModule&quot;/&gt;
      ...
    &lt;/modules&gt;
  &lt;/system.webServer&gt;
&lt;/configuration&gt;
</pre><p>After all of those configuration changes your Web Site is fully adopted to ASP.NET MVC framework usage. So, just go ahead and feel the awesomeness of MVC!<br />
</p></div>

      
      
    </div>
  </div>

    </article>
  
  <div class="pagination inner pure-u-1">
    
      <a class="prev" href="/blog/page/11/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/9/">Newer &rarr;</a>
    
  </div>
</div></div>
	<footer class="pure-g-r"><div class="inner pure-u-1">
	<p>
		Theme by <a href="https://twitter.com/alexbeletsky">@alexbeletsky</a> | Fonts by <a href="http://www.google.com/fonts/">Google Fonts</a> | Icons by <a href="http://fontello.com/">Fontello</a> | Hosted on <a href="http://github.com">github</a> | Powered by <a href="http://octopress.org/">Octopress</a>
	</p>
	<p>
		Copyright  2010 - 2013 beletsky.net
	</p>
</div>

</footer>
	<div class="buttons">
	


	
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


	
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


	
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


	

</div>
</body>
</html>